<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Concert CSV Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            padding: 40px 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            color: #1db954;
            margin-bottom: 30px;
            font-size: 32px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #ffffff;
        }
        .required {
            color: #ff4444;
        }
        input[type="text"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #333;
            border-radius: 6px;
            background-color: #2a2a2a;
            color: #ffffff;
            font-size: 14px;
            font-family: inherit;
        }
        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            outline: none;
            border-color: #1db954;
        }
        textarea {
            min-height: 200px;
            resize: vertical;
            font-family: monospace;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .help-text {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }
        button {
            background-color: #1db954;
            color: #ffffff;
            border: none;
            padding: 14px 32px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        button:hover {
            background-color: #1ed760;
        }
        button:active {
            background-color: #1aa34a;
        }
        .section {
            background-color: #2a2a2a;
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 24px;
        }
        .section-title {
            color: #1db954;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        .results-container {
            margin-top: 40px;
        }
        .user-stats {
            background-color: #2a2a2a;
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 24px;
        }
        .user-stats h2 {
            color: #1db954;
            margin-bottom: 20px;
            font-size: 24px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        .stat-item {
            background-color: #1a1a1a;
            padding: 16px;
            border-radius: 6px;
        }
        .stat-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 4px;
        }
        .stat-value {
            font-size: 20px;
            font-weight: 600;
            color: #1db954;
        }
        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .toggle-btn {
            background-color: #2a2a2a;
            color: #ffffff;
            border: 2px solid #333;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        .toggle-btn:hover {
            border-color: #1db954;
        }
        .toggle-btn.active {
            background-color: #1db954;
            border-color: #1db954;
        }
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .gallery-item {
            background-color: #2a2a2a;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .gallery-item .svg-container {
            width: 100%;
            aspect-ratio: 1 / 1;
            background-color: #1a1a1a;
            border: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .gallery-item .svg-container svg {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .gallery-item img {
            width: 100%;
            aspect-ratio: 1 / 1;
            object-fit: contain;
            display: block;
            background-color: #1a1a1a;
            border: 1px solid #333;
        }
        .gallery-item img:hover {
            border-color: #1db954;
        }
        .user-overview-img {
            width: 100%;
            max-width: 800px;
            aspect-ratio: 1 / 1;
            object-fit: contain;
            border-radius: 6px;
            background-color: #1a1a1a;
            border: 1px solid #333;
            display: block;
            margin: 0 auto;
        }
        .user-overview-img:hover {
            border-color: #1db954;
        }
        .user-overview-container {
            width: 100%;
            max-width: 800px;
            aspect-ratio: 1 / 1;
            margin: 0 auto;
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .user-overview-container svg {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .gallery-item-info {
            padding: 12px;
        }
        .gallery-item-name {
            font-weight: 600;
            margin-bottom: 8px;
            color: #ffffff;
        }
        .gallery-item-actions {
            display: flex;
            gap: 8px;
        }
        .btn-download {
            background-color: #1db954;
            color: #ffffff;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            flex: 1;
        }
        .btn-download:hover {
            background-color: #1ed760;
        }
        .btn-download-all {
            background-color: #333;
            color: #ffffff;
            border: 2px solid #1db954;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        .btn-download-all:hover {
            background-color: #1db954;
        }
        .hidden {
            display: none;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        .error {
            background-color: #ff4444;
            color: #ffffff;
            padding: 16px;
            border-radius: 6px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Concert CSV Analyzer</h1>
        <form id="analyzeForm" method="POST" action="/api/v1/analyze-concert">
            <div class="section">
                <div class="section-title">Required Fields</div>
                <div class="form-group">
                    <label for="csv_str">CSV Content <span class="required">*</span></label>
                    <textarea id="csv_str" name="csv_str" required placeholder="Paste your CSV content here..."></textarea>
                    <div class="help-text">Paste the entire CSV content as a string</div>
                </div>
                <div class="form-group">
                    <label for="filter_year">Filter Year <span class="required">*</span></label>
                    <input type="number" id="filter_year" name="filter_year" required placeholder="2025" min="1900" max="2100">
                    <div class="help-text">Year to filter the concerts by</div>
                </div>
                <div class="form-group">
                    <label for="user_name">User Name <span class="required">*</span></label>
                    <input type="text" id="user_name" name="user_name" required placeholder="cyber_chris">
                    <div class="help-text">User name for the analysis</div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Column Names (Optional)</div>
                <div class="form-group">
                    <label for="date">Date Column</label>
                    <input type="text" id="date" name="date" value="Date" placeholder="Date">
                </div>
                <div class="form-group">
                    <label for="artist">Artist Column</label>
                    <input type="text" id="artist" name="artist" value="Artist" placeholder="Artist">
                </div>
                <div class="form-group">
                    <label for="venue">Venue Column</label>
                    <input type="text" id="venue" name="venue" value="Venue" placeholder="Venue">
                </div>
                <div class="form-group">
                    <label for="city_column">City Column</label>
                    <input type="text" id="city_column" name="city_column" value="City" placeholder="City">
                </div>
                <div class="form-group">
                    <label for="country">Country Column</label>
                    <input type="text" id="country" name="country" value="Country" placeholder="Country">
                </div>
                <div class="form-group">
                    <label for="paid_price">Paid Price Column</label>
                    <input type="text" id="paid_price" name="paid_price" value="Bezahlt Preis" placeholder="Bezahlt Preis">
                </div>
                <div class="form-group">
                    <label for="original_price">Original Price Column</label>
                    <input type="text" id="original_price" name="original_price" value="Preis" placeholder="Preis">
                </div>
                <div class="form-group">
                    <label for="merch_cost">Merch Cost Column</label>
                    <input type="text" id="merch_cost" name="merch_cost" value="Merch Ausgaben" placeholder="Merch Ausgaben">
                </div>
                <div class="form-group">
                    <label for="type">Type Column</label>
                    <input type="text" id="type" name="type" value="Typ" placeholder="Typ">
                </div>
                <div class="form-group">
                    <label for="event_name">Event Name Column</label>
                    <input type="text" id="event_name" name="event_name" value="Event Name" placeholder="Event Name">
                </div>
            </div>

            <div class="section">
                <div class="section-title">Options</div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="running_order_headline_last" name="running_order_headline_last" checked>
                        <label for="running_order_headline_last">Running order: headline last</label>
                    </div>
                    <div class="help-text">If checked, the order is correct (headline last). If unchecked, reverse the order (headline first).</div>
                </div>
            </div>

            <button type="submit">Analyze Concert Data</button>
        </form>

        <div id="resultsContainer" class="results-container hidden">
            <div class="user-stats" id="userStats"></div>

            <div class="view-toggle">
                <button class="toggle-btn active" data-view="artists" id="toggleArtists">Artists</button>
                <button class="toggle-btn" data-view="venues" id="toggleVenues">Venues</button>
            </div>

            <button class="btn-download-all" id="downloadAllBtn">Download All SVGs as ZIP</button>

            <div id="galleryArtists" class="gallery"></div>
            <div id="galleryVenues" class="gallery hidden"></div>
        </div>

        <div id="loading" class="loading hidden">Processing your data...</div>
        <div id="error" class="error hidden"></div>
    </div>
    <script>
        (function() {
            console.log("[init] Initializing form handler");
            const form = document.getElementById("analyzeForm");
            if (!form) {
                console.error("[init] Form element not found!");
                return;
            }

            console.log("[init] Form found, adding submit listener...");

            form.addEventListener("submit", async function(e) {
                e.preventDefault();
                console.log("[submit] Form submitted, preventing default");
                console.log("[submit] Event:", e.type, "target:", e.target?.id);

                const formData = new FormData(e.target);
                const data = {
                    csv_str: formData.get("csv_str"),
                    filter_year: parseInt(formData.get("filter_year")),
                    user_name: formData.get("user_name") || "",
                    city: "[unset]",
                    date: formData.get("date") || "Date",
                    artist: formData.get("artist") || "Artist",
                    venue: formData.get("venue") || "Venue",
                    city_column: formData.get("city_column") || "City",
                    country: formData.get("country") || "Country",
                    paid_price: formData.get("paid_price") || "Bezahlt Preis",
                    original_price: formData.get("original_price") || "Preis",
                    merch_cost: formData.get("merch_cost") || "Merch Ausgaben",
                    type: formData.get("type") || "Typ",
                    event_name: formData.get("event_name") || "Event Name",
                    running_order_headline_last: formData.get("running_order_headline_last") === "on"
                };

                console.log("[submit] Sending request to /api/v1/analyze-concert");
                console.log("[submit] Request data:", data);
                console.log("[submit] Data size:", JSON.stringify(data).length, "bytes");

                // Show loading, hide results and error
                console.log("[submit] Showing loading state");
                const loadingEl = document.getElementById("loading");
                const resultsEl = document.getElementById("resultsContainer");
                const errorEl = document.getElementById("error");

                if (loadingEl) loadingEl.classList.remove("hidden");
                if (resultsEl) resultsEl.classList.add("hidden");
                if (errorEl) errorEl.classList.add("hidden");

                const startTime = performance.now();
                try {
                    console.log("[submit] Initiating fetch request");
                    const response = await fetch("/api/v1/analyze-concert", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(data)
                    });

                    const requestTime = performance.now() - startTime;
                    console.log(`[submit] Response received in ${requestTime.toFixed(2)}ms`);
                    console.log("[submit] Response status:", response.status, response.statusText);
                    console.log("[submit] Response headers:", Object.fromEntries(response.headers.entries()));

                    if (response.ok) {
                        console.log("[submit] Response OK, parsing JSON");
                        const result = await response.json();
                        console.log("[submit] JSON parsed successfully");
                        console.log("[submit] Result structure:", {
                            request_id: result.request_id,
                            user_svg: result.user_svg,
                            artist_svgs_count: result.artist_svgs?.length || 0,
                            venue_svgs_count: result.venue_svgs?.length || 0,
                        });
                        displayResults(result);
                    } else {
                        console.error("[submit] Response not OK, reading error text");
                        const errorText = await response.text();
                        console.error("[submit] Error response body:", errorText);
                        showError("Error: " + response.statusText + "\n" + errorText);
                    }
                } catch (error) {
                    const requestTime = performance.now() - startTime;
                    console.error(`[submit] Fetch error after ${requestTime.toFixed(2)}ms:`, error);
                    console.error("[submit] Error name:", error.name);
                    console.error("[submit] Error message:", error.message);
                    console.error("[submit] Error stack:", error.stack);
                    showError("Error: " + error.message);
                } finally {
                    console.log("[submit] Hiding loading state");
                    if (loadingEl) loadingEl.classList.add("hidden");
                }
            });

            console.log("Submit listener added successfully");

            // View toggle functionality
            console.log("[init] Setting up view toggle buttons");
            const toggleArtistsBtn = document.getElementById("toggleArtists");
            const toggleVenuesBtn = document.getElementById("toggleVenues");

            if (toggleArtistsBtn) {
                toggleArtistsBtn.addEventListener("click", () => {
                    console.log("[toggle] Artists button clicked");
                    switchView("artists");
                });
            } else {
                console.warn("[init] Toggle artists button not found");
            }

            if (toggleVenuesBtn) {
                toggleVenuesBtn.addEventListener("click", () => {
                    console.log("[toggle] Venues button clicked");
                    switchView("venues");
                });
            } else {
                console.warn("[init] Toggle venues button not found");
            }

            console.log("[init] Initialization complete");

            function switchView(view) {
                console.log(`[switchView] Switching to ${view} view`);
                const artistsBtn = document.getElementById("toggleArtists");
                const venuesBtn = document.getElementById("toggleVenues");
                const artistsGallery = document.getElementById("galleryArtists");
                const venuesGallery = document.getElementById("galleryVenues");

                if (view === "artists") {
                    console.log("[switchView] Showing artists, hiding venues");
                    artistsBtn.classList.add("active");
                    venuesBtn.classList.remove("active");
                    artistsGallery.classList.remove("hidden");
                    venuesGallery.classList.add("hidden");
                } else {
                    console.log("[switchView] Showing venues, hiding artists");
                    artistsBtn.classList.remove("active");
                    venuesBtn.classList.add("active");
                    artistsGallery.classList.add("hidden");
                    venuesGallery.classList.remove("hidden");
                }
            }

            function displayResults(result) {
                console.log("[displayResults] Starting to display results", result);

                // Display user high-level SVG
                const userStats = document.getElementById("userStats");
                console.log("[displayResults] User stats container found:", !!userStats);

                const userSvgUrl = `/api/v1/svg/${encodeURIComponent(result.user_svg)}`;
                console.log("[displayResults] User SVG URL:", userSvgUrl);

                // Try to load and render SVG inline
                fetch(userSvgUrl)
                    .then(response => {
                        if (response.ok) {
                            return response.text();
                        }
                        throw new Error(`HTTP ${response.status}`);
                    })
                    .then(svgText => {
                        console.log("[displayResults] User SVG fetched successfully, rendering inline");
                        const userStats = document.getElementById("userStats");
                        userStats.innerHTML = `
                            <h2>Your Concert Overview</h2>
                            <div style="margin-top: 20px; text-align: center;">
                                <div class="user-overview-container">
                                    ${svgText}
                                </div>
                            </div>
                        `;
                    })
                    .catch(error => {
                        console.warn("[displayResults] Failed to fetch SVG for inline rendering, using img tag:", error);
                        const userStats = document.getElementById("userStats");
                        userStats.innerHTML = `
                            <h2>Your Concert Overview</h2>
                            <div style="margin-top: 20px; text-align: center;">
                                <img id="userOverviewImg" src="${userSvgUrl}" alt="User Overview" class="user-overview-img"
                                     onerror="console.error('[displayResults] Failed to load user SVG:', this.src); this.style.display='none'; this.nextElementSibling.style.display='block';"
                                     onload="console.log('[displayResults] User SVG loaded successfully:', this.src); this.style.display='block';">
                                <div style="display: none; color: #ff4444; padding: 20px;">
                                    Failed to load overview image. <a href="${userSvgUrl}" target="_blank" style="color: #1db954;">Try opening directly</a>
                                </div>
                            </div>
                        `;
                    });

                console.log("[displayResults] User SVG set:", result.user_svg);

                // Display artist gallery
                console.log("[displayResults] Displaying artist gallery, count:", result.artist_svgs?.length || 0);
                const artistsGallery = document.getElementById("galleryArtists");
                artistsGallery.innerHTML = "";
                if (result.artist_svgs && result.artist_svgs.length > 0) {
                    // Use Promise.all to load all SVGs
                    Promise.all(result.artist_svgs.map(async (svgPath, index) => {
                        console.log(`[displayResults] Adding artist SVG ${index + 1}/${result.artist_svgs.length}:`, svgPath);
                        const fileName = svgPath.split("/").pop();
                        return await createGalleryItem(svgPath, fileName, "artist");
                    })).then(items => {
                        items.forEach(item => artistsGallery.appendChild(item));
                        console.log("[displayResults] All artist gallery items added");
                    }).catch(error => {
                        console.error("[displayResults] Error loading artist gallery items:", error);
                    });
                } else {
                    console.warn("[displayResults] No artist SVGs found in result");
                }

                // Display venue gallery
                console.log("[displayResults] Displaying venue gallery, count:", result.venue_svgs?.length || 0);
                const venuesGallery = document.getElementById("galleryVenues");
                venuesGallery.innerHTML = "";
                if (result.venue_svgs && result.venue_svgs.length > 0) {
                    // Use Promise.all to load all SVGs
                    Promise.all(result.venue_svgs.map(async (svgPath, index) => {
                        console.log(`[displayResults] Adding venue SVG ${index + 1}/${result.venue_svgs.length}:`, svgPath);
                        const fileName = svgPath.split("/").pop();
                        return await createGalleryItem(svgPath, fileName, "venue");
                    })).then(items => {
                        items.forEach(item => venuesGallery.appendChild(item));
                        console.log("[displayResults] All venue gallery items added");
                    }).catch(error => {
                        console.error("[displayResults] Error loading venue gallery items:", error);
                    });
                } else {
                    console.warn("[displayResults] No venue SVGs found in result");
                }

                // Set up download all button
                const downloadAllBtn = document.getElementById("downloadAllBtn");
                if (downloadAllBtn) {
                    downloadAllBtn.onclick = () => {
                        console.log("[displayResults] Download all clicked for request_id:", result.request_id);
                        window.location.href = `/api/v1/download-all/${result.request_id}`;
                    };
                } else {
                    console.error("[displayResults] Download all button not found");
                }

                // Show results
                console.log("[displayResults] Showing results container");
                document.getElementById("resultsContainer").classList.remove("hidden");
                console.log("[displayResults] Results displayed successfully");
            }

            async function createGalleryItem(svgPath, fileName, type) {
                console.log(`[createGalleryItem] Creating ${type} gallery item:`, fileName);
                const item = document.createElement("div");
                item.className = "gallery-item";
                const displayName = fileName.replace(".svg", "").replace(/^solo-(artist|venue)-\d+-/, "");
                const svgUrl = `/api/v1/svg/${encodeURIComponent(svgPath)}`;
                const downloadUrl = `/api/v1/download/${encodeURIComponent(svgPath)}`;

                // Try to load SVG and render it
                try {
                    console.log(`[createGalleryItem] Fetching SVG from: ${svgUrl}`);
                    const svgResponse = await fetch(svgUrl);
                    if (svgResponse.ok) {
                        const svgText = await svgResponse.text();
                        console.log(`[createGalleryItem] SVG fetched successfully, length: ${svgText.length} chars`);

                        // Create a container for the SVG with square aspect ratio
                        item.innerHTML = `
                            <div class="svg-container">
                                ${svgText}
                            </div>
                            <div class="gallery-item-info">
                                <div class="gallery-item-name">${displayName}</div>
                                <div class="gallery-item-actions">
                                    <button class="btn-download" onclick="console.log('[createGalleryItem] Download clicked:', '${downloadUrl}'); window.location.href='${downloadUrl}'">
                                        Download
                                    </button>
                                </div>
                            </div>
                        `;
                    } else {
                        console.warn(`[createGalleryItem] Failed to fetch SVG, status: ${svgResponse.status}`);
                        // Fallback to img tag
                        item.innerHTML = `
                            <img src="${svgUrl}" alt="${displayName}" loading="lazy"
                                 onerror="console.error('[createGalleryItem] Failed to load SVG:', this.src); this.style.border='2px solid #ff4444';"
                                 onload="console.log('[createGalleryItem] SVG loaded via img tag:', this.src)">
                            <div class="gallery-item-info">
                                <div class="gallery-item-name">${displayName}</div>
                                <div class="gallery-item-actions">
                                    <button class="btn-download" onclick="console.log('[createGalleryItem] Download clicked:', '${downloadUrl}'); window.location.href='${downloadUrl}'">
                                        Download
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error(`[createGalleryItem] Error loading SVG:`, error);
                    // Fallback to img tag
                    item.innerHTML = `
                        <img src="${svgUrl}" alt="${displayName}" loading="lazy"
                             onerror="console.error('[createGalleryItem] Failed to load SVG:', this.src); this.style.border='2px solid #ff4444';"
                             onload="console.log('[createGalleryItem] SVG loaded via img tag:', this.src)">
                        <div class="gallery-item-info">
                            <div class="gallery-item-name">${displayName}</div>
                            <div class="gallery-item-actions">
                                <button class="btn-download" onclick="console.log('[createGalleryItem] Download clicked:', '${downloadUrl}'); window.location.href='${downloadUrl}'">
                                    Download
                                </button>
                            </div>
                        </div>
                    `;
                }

                console.log(`[createGalleryItem] Gallery item created for ${displayName}`);
                return item;
            }

            function showError(message) {
                console.error("[showError] Displaying error:", message);
                const errorDiv = document.getElementById("error");
                if (errorDiv) {
                    errorDiv.textContent = message;
                    errorDiv.classList.remove("hidden");
                } else {
                    console.error("[showError] Error div not found in DOM");
                }
            }
        })();
    </script>
</body>
</html>
