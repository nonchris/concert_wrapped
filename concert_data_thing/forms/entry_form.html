<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="favicon.png">
    <title style="color: #fff700; text-shadow: 0 0 9px #fff700, 0 0 25px #fff700;">Cyber Chris's Concert CSV Analyzer</title>
    <style>
        :root {
            --color-bg-dark: #1a1a1a;
            --color-bg-medium: #2a2a2a;
            --color-text-primary: #ffffff;
            --color-text-secondary: #888;
            --color-primary: #ffe600;
            --color-primary-hover: #fff700;
            --color-primary-active: #cab200;
            --color-border: #474747;
            --color-error: #ff4444;
            --color-button-text: #000000;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--color-bg-dark);
            color: var(--color-text-primary);
            padding: 40px 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            color: var(--color-primary);
            margin-bottom: 30px;
            font-size: 32px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--color-text-primary);
        }
        .required {
            color: var(--color-error);
        }
        input[type="text"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            background-color: var(--color-bg-medium);
            color: var(--color-text-primary);
            font-size: 14px;
            font-family: inherit;
        }
        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--color-primary);
        }
        textarea {
            min-height: 200px;
            resize: vertical;
            font-family: monospace;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .help-text {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-top: 4px;
        }
        button {
            background-color: var(--color-primary);
            color: var(--color-button-text);
            border: none;
            padding: 14px 32px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        button:hover {
            background-color: var(--color-primary-hover);
        }
        button:active {
            background-color: var(--color-primary-active);
        }
        .section {
            background-color: var(--color-bg-medium);
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 24px;
        }
        .section-title {
            color: var(--color-primary);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        .results-container {
            margin-top: 40px;
        }
        .user-stats {
            background-color: var(--color-bg-medium);
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 24px;
        }
        .user-stats h2 {
            color: var(--color-primary);
            margin-bottom: 20px;
            font-size: 24px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        .stat-item {
            background-color: var(--color-bg-dark);
            padding: 16px;
            border-radius: 6px;
        }
        .stat-label {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-bottom: 4px;
        }
        .stat-value {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-primary);
        }
        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .toggle-btn {
            background-color: var(--color-bg-medium);
            color: var(--color-text-primary);
            border: 2px solid var(--color-border);
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        .toggle-btn:hover {
            border-color: var(--color-primary);
        }
        .toggle-btn.active {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            color: var(--color-button-text);
        }
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .gallery-full-width {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .gallery-full-width .gallery-item {
            max-width: 100%;
        }
        .gallery-full-width .svg-container {
            max-width: 100%;
        }
        .gallery-item {
            background-color: var(--color-bg-medium);
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .gallery-item .svg-container {
            width: 100%;
            aspect-ratio: 1 / 1;
            background-color: var(--color-bg-dark);
            border: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .gallery-item .svg-container svg {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .gallery-item img {
            width: 100%;
            aspect-ratio: 1 / 1;
            object-fit: contain;
            display: block;
            background-color: var(--color-bg-dark);
            border: 1px solid var(--color-border);
        }
        .gallery-item img:hover {
            border-color: var(--color-primary);
        }
        .user-overview-img {
            width: 100%;
            max-width: 800px;
            aspect-ratio: 1 / 1;
            object-fit: contain;
            border-radius: 6px;
            background-color: var(--color-bg-dark);
            border: 1px solid var(--color-border);
            display: block;
            margin: 0 auto;
        }
        .user-overview-img:hover {
            border-color: var(--color-primary);
        }
        .user-overview-container {
            width: 100%;
            aspect-ratio: 1 / 1;
            background-color: var(--color-bg-dark);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .user-overview-container svg {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .gallery-full-width .gallery-item .svg-container {
            aspect-ratio: 1 / 1;
        }
        .gallery-item-info {
            padding: 12px;
        }
        .gallery-item-name {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--color-text-primary);
        }
        .gallery-item-actions {
            display: flex;
            gap: 8px;
        }
        .btn-download {
            background-color: var(--color-primary);
            color: var(--color-button-text);
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            flex: 1;
        }
        .btn-download:hover {
            background-color: var(--color-primary-hover);
        }
        .btn-download-all {
            background-color: var(--color-border);
            color: var(--color-text-primary);
            border: 2px solid var(--color-primary);
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        .btn-download-all:hover {
            background-color: var(--color-primary);
            color: var(--color-button-text);
        }
        .hidden {
            display: none;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--color-text-secondary);
        }
        .error {
            background-color: var(--color-error);
            color: var(--color-text-primary);
            padding: 16px;
            border-radius: 6px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="color: #fff700; text-shadow: 0 0 2px rgba(255,247,0,0.66), 0 0 10px rgba(255,247,0,0.66);">Cyber Chris's Concert CSV Analyzer</h1>
        <form id="analyzeForm" method="POST" action="/api/v1/analyze-concert">
            <div class="section">
                <div class="section-title">Required Fields</div>
                <div class="form-group">
                    <label for="csv_str">CSV Content <span class="required">*</span></label>
                    <textarea id="csv_str" name="csv_str" required placeholder="Paste your CSV content here..."></textarea>
                    <div class="help-text">
                        <br>
                        Paste the entire CSV content as a text.<br>
                        The first row of your data must contain the column names.<br>
                        It is important that the data you provide is complete for all columns listed below (for the year you want to have analyzed).<br>
                        Your data may have additional columns, they will not affect the process.<br>
                        Empty rows are no problem as well.<br>
                        You can find an example CSV <a href="/api/v1/example-data">here</a>.
                        <br><br>
                        "Comma-Separated Values" is a data format where the values of each row are separated by specific character.<br>
                        Nearly every spreadsheet editor supports the export of a table as CSV.<br>
                        You can configure the chosen separator character below under "Options".
                    </div>
                </div>
                <div class="form-group">
                    <label for="filter_year">Filter Year <span class="required">*</span></label>
                    <input type="number" id="filter_year" name="filter_year" required placeholder="2025" min="1900" max="2100">
                    <div class="help-text">Year you want to generate stats for</div>
                </div>
                <div class="form-group">
                    <label for="user_name">User Name <span class="required">*</span></label>
                    <input type="text" id="user_name" name="user_name" required placeholder="cyber_chris">
                    <div class="help-text">User name to be displayed.</div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Column Names (Optional)
                    <div class="help-text">
                        Here you declare how the data columns are called in your pasted table.
                        Not all of these columns are currently used in analysis, but it's required to label them all.
                </div>
            </div>

                <div class="form-group">
                    <label for="date">Date Column</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="date" name="date" value="Date" placeholder="Date" style="flex: 0.5;">
                        <input type="text" id="date_format" name="date_format" value="%d.%m.%y" placeholder="%d.%m.%y" style="flex: 1;">
                    </div>
                    <div class="help-text">Date column name (left) and how to interpret date format (right). Examples: %d.%m.%y, %Y-%m-%d, %m/%d/%Y</div>
                </div>
                <div class="form-group">
                    <label for="artist">Artist Column</label>
                    <input type="text" id="artist" name="artist" value="Artist" placeholder="Artist">
                </div>
                <div class="form-group">
                    <label for="venue">Venue Column</label>
                    <input type="text" id="venue" name="venue" value="Venue" placeholder="Venue">
                </div>
                <div class="form-group">
                    <label for="city_column">City Column</label>
                    <input type="text" id="city_column" name="city_column" value="City" placeholder="City">
                </div>
                <div class="form-group">
                    <label for="country">Country Column</label>
                    <input type="text" id="country" name="country" value="Country" placeholder="Country">
                </div>
                <div class="form-group">
                    <label for="paid_price">Paid Price Column</label>
                    <input type="text" id="paid_price" name="paid_price" value="Bezahlt Preis" placeholder="Bezahlt Preis">
                </div>
                <div class="form-group">
                    <label for="type">Type Column</label>
                    <input type="text" id="type" name="type" value="Typ" placeholder="Typ">
                    <div class="help-text">
                        Column labeling what type of show a row is (headline, support, festival).<br>
                        There are two modes available to detect whether an entry is a headline, support show:<br>
                        Order the rows (per date) in a way that the headliner is always the first or last entry and declare type binary (festival, not festival).<br>
                        Provide a more sophisticated column to declare it using three labels instead of two ('franka-style').
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <div style="flex: 1;">
                            <label for="festival_label" style="font-size: 12px; color: var(--color-text-secondary);">Festival Label <span class="required">*</span></label>
                            <input type="text" id="festival_label" name="festival_label" value="F" placeholder="F" required style="margin-top: 4px;">
                            <div class="help-text" style="font-size: 11px; margin-top: 2px;">Required: value in Type column for festivals</div>
                        </div>
                        <div style="flex: 1;">
                            <label for="headline_label" style="font-size: 12px; color: var(--color-text-secondary);">Headline Label</label>
                            <input type="text" id="headline_label" name="headline_label" value="auto" placeholder="auto" style="margin-top: 4px;">
                            <div class="help-text" style="font-size: 11px; margin-top: 2px;">"auto" = detect by running order, or enter value</div>
                        </div>
                        <div style="flex: 1;">
                            <label for="support_label" style="font-size: 12px; color: var(--color-text-secondary);">Support Label</label>
                            <input type="text" id="support_label" name="support_label" value="auto" placeholder="auto" style="margin-top: 4px;">
                            <div class="help-text" style="font-size: 11px; margin-top: 2px;">"auto" = detect by running order, or enter value</div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="event_name">Event Name Column</label>
                    <input type="text" id="event_name" name="event_name" value="Event Name" placeholder="Event Name">
                    <div class="help-text">
                        This column is used to give events a label that overwrites the name of the headline band.<br>
                        You may wanna use it for festivals or if you want to give a tour a certain name.<br>
                        It may be partially empty, it's just important that all events that are labeled are labeld the same in all rows.
                    </div>
                </div>
                <div class="form-group">
                    <label for="original_price">Original Price Column</label>
                    <input type="text" id="original_price" name="original_price" value="Preis" placeholder="Preis">
                    <div class="help-text">Currently unused, may be (partially) empty - just declare that it is present.</div>
                </div>
                <div class="form-group">
                    <label for="merch_cost">Merch Cost Column</label>
                    <input type="text" id="merch_cost" name="merch_cost" value="Merch Ausgaben" placeholder="Merch Ausgaben">
                    <div class="help-text">Currently unused, may be (partially) empty - just declare that it is present.</div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Options</div>
                <div class="form-group">
                    <label for="sep">CSV Separator</label>
                    <input type="text" id="sep" name="sep" value="," placeholder="," style="width: 80px;">
                    <div class="help-text">Character used to separate values in your CSV. Common values: "," (comma), ";" (semicolon), "\t" (tab - enter as two characters: backslash and t)</div>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="running_order_headline_last" name="running_order_headline_last" checked>
                        <label for="running_order_headline_last">Running order: headline last</label>
                    </div>
                    <div class="help-text">If checked, the order is correct (headline last). If unchecked, reverse the order (headline first). No effect if labeled 'franka-style'.</div>
                </div>
                <div class="form-group">
                    <div style="display: flex; gap: 10px;">
                        <div style="flex: 1;">
                            <label for="gradient_high">Gradient Top Color</label>
                            <input type="color" id="gradient_high" name="gradient_high" value="#000000">
                        </div>
                        <div style="flex: 1;">
                            <label for="gradient_low">Gradient Bottom Color</label>
                            <input type="color" id="gradient_low" name="gradient_low" value="#0000FF">
                        </div>
                        <div style="flex: 1;">
                            <label for="text_color">Text Color</label>
                            <input type="color" id="text_color" name="text_color" value="#00FF00">
                        </div>
                    </div>
                    <div class="help-text">Here you can customize your basic color scheme.</div>
                </div>
            </div>

            <button type="submit">Analyze Concert Data</button>
        </form>

        <div id="resultsContainer" class="results-container hidden">
            <div class="user-stats" id="userStats">
                <h2>Your Concert Overview</h2>
                <div id="galleryUser" class="gallery-full-width"></div>
            </div>

            <div class="view-toggle">
                <button class="toggle-btn active" data-view="artists" id="toggleArtists">Artists</button>
                <button class="toggle-btn" data-view="venues" id="toggleVenues">Venues</button>
                <button class="toggle-btn" data-view="cities" id="toggleCities">Cities</button>
            </div>

            <button class="btn-download-all" id="downloadAllBtn">Download All SVGs as ZIP</button>

            <div id="galleryArtists" class="gallery"></div>
            <div id="galleryVenues" class="gallery hidden"></div>
            <div id="galleryCities" class="gallery hidden"></div>
        </div>

        <div id="loading" class="loading hidden">Processing your data...</div>
        <div id="error" class="error hidden"></div>
    </div>
    <script>
        (function() {
            console.log("[init] Initializing form handler");
            const form = document.getElementById("analyzeForm");
            if (!form) {
                console.error("[init] Form element not found!");
                return;
            }

            console.log("[init] Form found, adding submit listener...");

            form.addEventListener("submit", async function(e) {
                e.preventDefault();
                console.log("[submit] Form submitted, preventing default");
                console.log("[submit] Event:", e.type, "target:", e.target?.id);

                const formData = new FormData(e.target);
                const data = {
                    csv_str: formData.get("csv_str"),
                    filter_year: parseInt(formData.get("filter_year")),
                    user_name: formData.get("user_name") || "",
                    city: "[unset]",
                    date: formData.get("date") || "Date",
                    date_format: formData.get("date_format") || "%d.%m.%y",
                    sep: (() => {
                        const sepValue = formData.get("sep") || ",";
                        // Handle special case: "\t" string should become actual tab character
                        if (sepValue === "\\t") {
                            return "\t";
                        }
                        return sepValue;
                    })(),
                    artist: formData.get("artist") || "Artist",
                    venue: formData.get("venue") || "Venue",
                    city_column: formData.get("city_column") || "City",
                    country: formData.get("country") || "Country",
                    paid_price: formData.get("paid_price") || "Bezahlt Preis",
                    original_price: formData.get("original_price") || "Preis",
                    merch_cost: formData.get("merch_cost") || "Merch Ausgaben",
                    type: formData.get("type") || "Typ",
                    headline_label: formData.get("headline_label") || "auto",
                    support_label: formData.get("support_label") || "auto",
                    festival_label: formData.get("festival_label") || "F",
                    event_name: formData.get("event_name") || "Event Name",
                    running_order_headline_last: formData.get("running_order_headline_last") === "on",
                    gradient_high: formData.get("gradient_high") || "#000000",
                    gradient_low: formData.get("gradient_low") || "#0000FF",
                    text_color: formData.get("text_color") || "#00FF00"
                };

                console.log("[submit] Sending request to /api/v1/analyze-concert");
                console.log("[submit] Request data:", data);
                console.log("[submit] Data size:", JSON.stringify(data).length, "bytes");

                // Show loading, hide results and error
                console.log("[submit] Showing loading state");
                const loadingEl = document.getElementById("loading");
                const resultsEl = document.getElementById("resultsContainer");
                const errorEl = document.getElementById("error");

                if (loadingEl) loadingEl.classList.remove("hidden");
                if (resultsEl) resultsEl.classList.add("hidden");
                if (errorEl) errorEl.classList.add("hidden");

                const startTime = performance.now();
                try {
                    console.log("[submit] Initiating fetch request");
                    const response = await fetch("/api/v1/analyze-concert", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(data)
                    });

                    const requestTime = performance.now() - startTime;
                    console.log(`[submit] Response received in ${requestTime.toFixed(2)}ms`);
                    console.log("[submit] Response status:", response.status, response.statusText);
                    console.log("[submit] Response headers:", Object.fromEntries(response.headers.entries()));

                    if (response.ok) {
                        console.log("[submit] Response OK, parsing JSON");
                        const result = await response.json();
                        console.log("[submit] JSON parsed successfully");
                        console.log("[submit] Result structure:", {
                            request_id: result.request_id,
                            user_svgs_count: result.user_svgs?.length || 0,
                            artist_svgs_count: result.artist_svgs?.length || 0,
                            venue_svgs_count: result.venue_svgs?.length || 0,
                            city_svgs_count: result.city_svgs?.length || 0,
                        });
                        displayResults(result);
                    } else {
                        console.error("[submit] Response not OK, reading error text");
                        const errorText = await response.text();
                        console.error("[submit] Error response body:", errorText);
                        showError("Error: " + response.statusText + "\n" + errorText);
                    }
                } catch (error) {
                    const requestTime = performance.now() - startTime;
                    console.error(`[submit] Fetch error after ${requestTime.toFixed(2)}ms:`, error);
                    console.error("[submit] Error name:", error.name);
                    console.error("[submit] Error message:", error.message);
                    console.error("[submit] Error stack:", error.stack);
                    showError("Error: " + error.message);
                } finally {
                    console.log("[submit] Hiding loading state");
                    if (loadingEl) loadingEl.classList.add("hidden");
                }
            });

            console.log("Submit listener added successfully");

            // View toggle functionality
            console.log("[init] Setting up view toggle buttons");
            const toggleArtistsBtn = document.getElementById("toggleArtists");
            const toggleVenuesBtn = document.getElementById("toggleVenues");
            const toggleCitiesBtn = document.getElementById("toggleCities");

            if (toggleArtistsBtn) {
                toggleArtistsBtn.addEventListener("click", () => {
                    console.log("[toggle] Artists button clicked");
                    switchView("artists");
                });
            } else {
                console.warn("[init] Toggle artists button not found");
            }

            if (toggleVenuesBtn) {
                toggleVenuesBtn.addEventListener("click", () => {
                    console.log("[toggle] Venues button clicked");
                    switchView("venues");
                });
            } else {
                console.warn("[init] Toggle venues button not found");
            }

            if (toggleCitiesBtn) {
                toggleCitiesBtn.addEventListener("click", () => {
                    console.log("[toggle] Cities button clicked");
                    switchView("cities");
                });
            } else {
                console.warn("[init] Toggle cities button not found");
            }

            console.log("[init] Initialization complete");

            function switchView(view) {
                console.log(`[switchView] Switching to ${view} view`);
                const artistsBtn = document.getElementById("toggleArtists");
                const venuesBtn = document.getElementById("toggleVenues");
                const citiesBtn = document.getElementById("toggleCities");
                const artistsGallery = document.getElementById("galleryArtists");
                const venuesGallery = document.getElementById("galleryVenues");
                const citiesGallery = document.getElementById("galleryCities");

                // Reset all buttons and galleries
                artistsBtn.classList.remove("active");
                venuesBtn.classList.remove("active");
                citiesBtn.classList.remove("active");
                artistsGallery.classList.add("hidden");
                venuesGallery.classList.add("hidden");
                citiesGallery.classList.add("hidden");

                // Activate selected view
                if (view === "artists") {
                    console.log("[switchView] Showing artists");
                    artistsBtn.classList.add("active");
                    artistsGallery.classList.remove("hidden");
                } else if (view === "venues") {
                    console.log("[switchView] Showing venues");
                    venuesBtn.classList.add("active");
                    venuesGallery.classList.remove("hidden");
                } else if (view === "cities") {
                    console.log("[switchView] Showing cities");
                    citiesBtn.classList.add("active");
                    citiesGallery.classList.remove("hidden");
                }
            }

            function displayResults(result) {
                console.log("[displayResults] Starting to display results", result);

                // Display user SVGs (treat as list)
                const userStats = document.getElementById("userStats");
                const userGallery = document.getElementById("galleryUser");
                console.log("[displayResults] User SVGs from result:", result.user_svgs);

                if (!result.user_svgs || result.user_svgs.length === 0) {
                    console.error("[displayResults] No user_svgs in result:", result);
                    userGallery.innerHTML = `
                        <div id="no-user-svgs-message" style="padding: 20px; color: #ff4444; background-color: #2a2a2a; border-radius: 6px;">
                            No overview images available. Please check the console for details.
                        </div>
                    `;
                    // Scroll to error message if no SVGs
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            const errorMsg = document.getElementById("no-user-svgs-message");
                            if (errorMsg) {
                                errorMsg.scrollIntoView({
                                    behavior: "smooth",
                                    block: "start",
                                    inline: "nearest"
                                });
                            }
                        });
                    });
                } else {
                    console.log(`[displayResults] Found ${result.user_svgs.length} user SVG(s)`);
                    // Load all user SVGs
                    Promise.all(result.user_svgs.map(async (svgPath, index) => {
                        const userSvgUrl = `/api/v1/svg/${encodeURIComponent(svgPath)}`;
                        console.log(`[displayResults] Loading user SVG ${index + 1}/${result.user_svgs.length}:`, userSvgUrl);
                        try {
                            const response = await fetch(userSvgUrl);
                            if (response.ok) {
                                const svgText = await response.text();
                                console.log(`[displayResults] User SVG ${index + 1} fetched successfully, length:`, svgText.length, "chars");
                                return { index, svgText, svgPath, success: true };
                            } else {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                        } catch (error) {
                            console.error(`[displayResults] Failed to fetch user SVG ${index + 1}:`, error);
                            return { index, svgPath, success: false, error: error.message };
                        }
                    })).then(results => {
                        const successful = results.filter(r => r.success);
                        const failed = results.filter(r => !r.success);

                        console.log(`[displayResults] Loaded ${successful.length}/${results.length} user SVGs successfully`);

                        userGallery.innerHTML = "";

                        if (successful.length > 0) {
                            // Display all successful SVGs in full-width gallery
                            successful.forEach((r, idx) => {
                                const item = document.createElement("div");
                                item.className = "gallery-item";
                                if (idx === 0) {
                                    item.id = "first-user-svg"; // Mark first item for scrolling
                                }
                                const fileName = r.svgPath.split("/").pop();
                                const displayName = fileName.replace(".svg", "").replace(/^user-high-level/, "Overview");
                                const downloadUrl = `/api/v1/download/${encodeURIComponent(r.svgPath)}`;

                                item.innerHTML = `
                                    <div class="svg-container">
                                        ${r.svgText}
                                    </div>
                                    <div class="gallery-item-info">
                                        <div class="gallery-item-name">${displayName}</div>
                                        <div class="gallery-item-actions">
                                            <button class="btn-download" onclick="console.log('[displayResults] Download clicked:', '${downloadUrl}'); window.location.href='${downloadUrl}'">
                                                Download
                                            </button>
                                        </div>
                                    </div>
                                `;
                                userGallery.appendChild(item);
                                console.log(`[displayResults] User SVG ${idx + 1} added to gallery`);

                                // Scroll immediately after first SVG is added
                                if (idx === 0) {
                                    // Use requestAnimationFrame to ensure DOM is updated
                                    requestAnimationFrame(() => {
                                        requestAnimationFrame(() => {
                                            // Scroll to user stats container (heading) instead of the SVG
                                            const userStats = document.getElementById("userStats");
                                            if (userStats) {
                                                console.log("[displayResults] Scrolling to user stats container (Your Concert Overview heading)");
                                                userStats.scrollIntoView({
                                                    behavior: "smooth",
                                                    block: "start",
                                                    inline: "nearest"
                                                });
                                            }
                                        });
                                    });
                                }
                            });
                        }

                        // Add fallback for failed SVGs
                        if (failed.length > 0) {
                            failed.forEach((r, idx) => {
                                const userSvgUrl = `/api/v1/svg/${encodeURIComponent(r.svgPath)}`;
                                const item = document.createElement("div");
                                item.className = "gallery-item";
                                // If no successful SVGs, mark first fallback for scrolling
                                if (successful.length === 0 && idx === 0) {
                                    item.id = "first-user-svg";
                                }
                                const fileName = r.svgPath.split("/").pop();
                                const displayName = fileName.replace(".svg", "").replace(/^user-high-level/, "Overview");
                                const downloadUrl = `/api/v1/download/${encodeURIComponent(r.svgPath)}`;

                                item.innerHTML = `
                                    <img src="${userSvgUrl}" alt="${displayName}" class="user-overview-img"
                                         onerror="console.error('[displayResults] Failed to load user SVG via img tag:', this.src);"
                                         onload="console.log('[displayResults] User SVG loaded via img tag:', this.src);">
                                    <div class="gallery-item-info">
                                        <div class="gallery-item-name">${displayName}</div>
                                        <div class="gallery-item-actions">
                                            <button class="btn-download" onclick="console.log('[displayResults] Download clicked:', '${downloadUrl}'); window.location.href='${downloadUrl}'">
                                                Download
                                            </button>
                                        </div>
                                    </div>
                                `;
                                userGallery.appendChild(item);

                                // Scroll immediately after first fallback is added (if no successful ones)
                                if (successful.length === 0 && idx === 0) {
                                    requestAnimationFrame(() => {
                                        requestAnimationFrame(() => {
                                            // Scroll to user stats container (heading) instead of the SVG
                                            const userStats = document.getElementById("userStats");
                                            if (userStats) {
                                                console.log("[displayResults] Scrolling to user stats container (fallback)");
                                                userStats.scrollIntoView({
                                                    behavior: "smooth",
                                                    block: "start",
                                                    inline: "nearest"
                                                });
                                            }
                                        });
                                    });
                                }
                            });
                        }
                    }).catch(error => {
                        console.error("[displayResults] Error loading user SVGs:", error);
                        userGallery.innerHTML = `
                            <div style="padding: 20px; color: #ff4444; background-color: #2a2a2a; border-radius: 6px;">
                                Error loading overview images: ${error.message}
                            </div>
                        `;
                    });
                }

                console.log("[displayResults] User SVGs processing initiated");

                // Display artist gallery
                console.log("[displayResults] Displaying artist gallery, count:", result.artist_svgs?.length || 0);
                const artistsGallery = document.getElementById("galleryArtists");
                artistsGallery.innerHTML = "";
                if (result.artist_svgs && result.artist_svgs.length > 0) {
                    // Use Promise.all to load all SVGs
                    Promise.all(result.artist_svgs.map(async (svgPath, index) => {
                        console.log(`[displayResults] Adding artist SVG ${index + 1}/${result.artist_svgs.length}:`, svgPath);
                        const fileName = svgPath.split("/").pop();
                        return await createGalleryItem(svgPath, fileName, "artist");
                    })).then(items => {
                        items.forEach(item => artistsGallery.appendChild(item));
                        console.log("[displayResults] All artist gallery items added");
                    }).catch(error => {
                        console.error("[displayResults] Error loading artist gallery items:", error);
                    });
                } else {
                    console.warn("[displayResults] No artist SVGs found in result");
                }

                // Display venue gallery
                console.log("[displayResults] Displaying venue gallery, count:", result.venue_svgs?.length || 0);
                const venuesGallery = document.getElementById("galleryVenues");
                venuesGallery.innerHTML = "";
                if (result.venue_svgs && result.venue_svgs.length > 0) {
                    // Use Promise.all to load all SVGs
                    Promise.all(result.venue_svgs.map(async (svgPath, index) => {
                        console.log(`[displayResults] Adding venue SVG ${index + 1}/${result.venue_svgs.length}:`, svgPath);
                        const fileName = svgPath.split("/").pop();
                        return await createGalleryItem(svgPath, fileName, "venue");
                    })).then(items => {
                        items.forEach(item => venuesGallery.appendChild(item));
                        console.log("[displayResults] All venue gallery items added");
                    }).catch(error => {
                        console.error("[displayResults] Error loading venue gallery items:", error);
                    });
                } else {
                    console.warn("[displayResults] No venue SVGs found in result");
                }

                // Display city gallery
                console.log("[displayResults] Displaying city gallery, count:", result.city_svgs?.length || 0);
                const citiesGallery = document.getElementById("galleryCities");
                citiesGallery.innerHTML = "";
                if (result.city_svgs && result.city_svgs.length > 0) {
                    // Use Promise.all to load all SVGs
                    Promise.all(result.city_svgs.map(async (svgPath, index) => {
                        console.log(`[displayResults] Adding city SVG ${index + 1}/${result.city_svgs.length}:`, svgPath);
                        const fileName = svgPath.split("/").pop();
                        return await createGalleryItem(svgPath, fileName, "city");
                    })).then(items => {
                        items.forEach(item => citiesGallery.appendChild(item));
                        console.log("[displayResults] All city gallery items added");
                    }).catch(error => {
                        console.error("[displayResults] Error loading city gallery items:", error);
                    });
                } else {
                    console.warn("[displayResults] No city SVGs found in result");
                }

                // Set up download all button
                const downloadAllBtn = document.getElementById("downloadAllBtn");
                if (downloadAllBtn) {
                    downloadAllBtn.onclick = () => {
                        console.log("[displayResults] Download all clicked for request_id:", result.request_id);
                        window.location.href = `/api/v1/download-all/${result.request_id}`;
                    };
                } else {
                    console.error("[displayResults] Download all button not found");
                }

                // Show results container immediately (before SVGs load) so we can scroll
                console.log("[displayResults] Showing results container");
                const resultsContainer = document.getElementById("resultsContainer");
                if (resultsContainer) {
                    resultsContainer.classList.remove("hidden");
                    // Scroll to user stats section immediately when container becomes visible
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            const userStats = document.getElementById("userStats");
                            if (userStats) {
                                console.log("[displayResults] Scrolling to user stats container (Your Concert Overview heading)");
                                userStats.scrollIntoView({
                                    behavior: "smooth",
                                    block: "start",
                                    inline: "nearest"
                                });
                            }
                        });
                    });
                }
                console.log("[displayResults] Results container shown, waiting for SVGs to load");
            }

            async function createGalleryItem(svgPath, fileName, type) {
                console.log(`[createGalleryItem] Creating ${type} gallery item:`, fileName);
                const item = document.createElement("div");
                item.className = "gallery-item";
                const displayName = fileName.replace(".svg", "").replace(/^solo-(artist|venue)-\d+-/, "");
                const svgUrl = `/api/v1/svg/${encodeURIComponent(svgPath)}`;
                const downloadUrl = `/api/v1/download/${encodeURIComponent(svgPath)}`;

                // Try to load SVG and render it
                try {
                    console.log(`[createGalleryItem] Fetching SVG from: ${svgUrl}`);
                    const svgResponse = await fetch(svgUrl);
                    if (svgResponse.ok) {
                        const svgText = await svgResponse.text();
                        console.log(`[createGalleryItem] SVG fetched successfully, length: ${svgText.length} chars`);

                        // Create a container for the SVG with square aspect ratio
                        item.innerHTML = `
                            <div class="svg-container">
                                ${svgText}
                            </div>
                            <div class="gallery-item-info">
                                <div class="gallery-item-name">${displayName}</div>
                                <div class="gallery-item-actions">
                                    <button class="btn-download" onclick="console.log('[createGalleryItem] Download clicked:', '${downloadUrl}'); window.location.href='${downloadUrl}'">
                                        Download
                                    </button>
                                </div>
                            </div>
                        `;
                    } else {
                        console.warn(`[createGalleryItem] Failed to fetch SVG, status: ${svgResponse.status}`);
                        // Fallback to img tag
                        item.innerHTML = `
                            <img src="${svgUrl}" alt="${displayName}" loading="lazy"
                                 onerror="console.error('[createGalleryItem] Failed to load SVG:', this.src); this.style.border='2px solid #ff4444';"
                                 onload="console.log('[createGalleryItem] SVG loaded via img tag:', this.src)">
                            <div class="gallery-item-info">
                                <div class="gallery-item-name">${displayName}</div>
                                <div class="gallery-item-actions">
                                    <button class="btn-download" onclick="console.log('[createGalleryItem] Download clicked:', '${downloadUrl}'); window.location.href='${downloadUrl}'">
                                        Download
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error(`[createGalleryItem] Error loading SVG:`, error);
                    // Fallback to img tag
                    item.innerHTML = `
                        <img src="${svgUrl}" alt="${displayName}" loading="lazy"
                             onerror="console.error('[createGalleryItem] Failed to load SVG:', this.src); this.style.border='2px solid #ff4444';"
                             onload="console.log('[createGalleryItem] SVG loaded via img tag:', this.src)">
                        <div class="gallery-item-info">
                            <div class="gallery-item-name">${displayName}</div>
                            <div class="gallery-item-actions">
                                <button class="btn-download" onclick="console.log('[createGalleryItem] Download clicked:', '${downloadUrl}'); window.location.href='${downloadUrl}'">
                                    Download
                                </button>
                            </div>
                        </div>
                    `;
                }

                console.log(`[createGalleryItem] Gallery item created for ${displayName}`);
                return item;
            }

            function showError(message) {
                console.error("[showError] Displaying error:", message);
                const errorDiv = document.getElementById("error");
                if (errorDiv) {
                    errorDiv.textContent = message;
                    errorDiv.classList.remove("hidden");
                } else {
                    console.error("[showError] Error div not found in DOM");
                }
            }
        })();
    </script>
</body>
</html>
